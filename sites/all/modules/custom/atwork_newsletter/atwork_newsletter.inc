<?php
/**
 *    The following variables are available:
 *    - $toc Table of content, if it exists, as generated by the function
 *    theme_scs_toc() or your own.
 *    - $nodes Array of built selected nodes, ready to be outputed with the
 *    render() function.
 *    - $comments Array of comment nid's, ready to be loaded ant then output
 *    - $notes String that has bullet points for the notes section.
 *    - $didYouKnow contains any text input from form.
 *
 *    @return array
 */

function atwork_newsletter_create_render_arrays($nodes, $comments, $notes, $did_you_know){
	$atwork_base_url = $GLOBALS['base_url'];
	$comment = NULL;

	// Check for Exec Messages
	foreach($nodes as $node){
	  foreach($node->field_tags['und'] as $terms) {
	  	$tag_object = taxonomy_term_load($terms['tid']);
	  	if($tag_object->name == 'Executive Messages') {
	    	$node->executive_message = TRUE;
	    } else {
	    	$node->executive_message = FALSE;
	    }	
    }
	}
	
	if($comments !== '') {
		// Load Comment Object
		$comment = comment_load($comments);
		
		// Retrieve Username from UID and place in comments array
		$user = user_load($comment->uid);
		$comment->name = $user->field_display_name['und'][0]['safe_value'];
		// We need to remove any image tags
		$comment->comment_body['und'][0]['formatted'] = preg_replace("/<img[^>]+\>/i", "", $comment->comment_body['und'][0]['value'] ); 
		// Get rid of <p>&nbsp;</p> if author has dropped in a bunch of returns
		$pattern = "/<p>*(?:[[:blank:]]|[[:space:]]|\s|\W|X|h|\t|\r|\n)*<\/p>/";
		$comment->comment_body['und'][0]['formatted'] = preg_replace($pattern, '',$comment->comment_body['und'][0]['formatted']);
		// Trim whitespace
		$comment->comment_body['und'][0]['formatted'] = trim($comment->comment_body['und'][0]['formatted']);
		// We need to check if this is an HTML comment or a regular text comment. Start by prefixing an x to the front so that we
		// Do not have to deal with the case where the match occurs at 0 (mistaken for false)
		// HTML Case
		if(strpos('x' . $comment->comment_body['und'][0]['formatted'], '<p>') !== false){
			// remove first and last <p> tags
			$comment->comment_body['und'][0]['formatted'] = substr($comment->comment_body['und'][0]['formatted'], 3);
			$comment->comment_body['und'][0]['formatted'] = substr($comment->comment_body['und'][0]['formatted'], 0, -4);
			// Change any double quotes to single quotes (if the author has started or ended comment with a quote or something)
			// NOTE: The double quotes that are used onsite are not regular " so we need to use the correct ones.
			$comment->comment_body['und'][0]['formatted'] = str_replace("“","'",$comment->comment_body['und'][0]['formatted']);
			$comment->comment_body['und'][0]['formatted'] = str_replace("”","'",$comment->comment_body['und'][0]['formatted']);
			$comment->comment_body['und'][0]['formatted'] = str_replace("\"","'",$comment->comment_body['und'][0]['formatted']);

			// Now replace all remaining <p> tags with proper formatting
			$comment->comment_body['und'][0]['formatted'] = str_replace('<p>', '<p class="outlook-comment-body" style="margin: 0 10px 0 15px; font-size: 12pt; font-family: Calibri,sans-serif; padding-bottom: 10px; line-height: 20px;">', $comment->comment_body['und'][0]['formatted']);
			// Now add double quotes to front and end of comment
			$comment->comment_body['und'][0]['formatted'] = "“" . $comment->comment_body['und'][0]['formatted'] . "”";
			// Adding in formating for outlook
			$comment->comment_body['und'][0]['formatted'] = '<p class="outlook-comment-body" style="margin: 0 10px 0 15px; font-size: 12pt; font-family: Calibri,sans-serif; padding-bottom: 10px; line-height: 20px;">' . $comment->comment_body['und'][0]['formatted'] . '</p>';
		}
		// Text case
		else {
			// replace all existing double-quotes with single quotes
			$comment->comment_body['und'][0]['formatted'] = str_replace("\"","'",$comment->comment_body['und'][0]['formatted']);
			// Add stylized quotes for newsletter
			$comment->comment_body['und'][0]['formatted'] = "“" . $comment->comment_body['und'][0]['formatted'] . "”";
			// Put in HTML tags so that we have the proper font
			$comment->comment_body['und'][0]['formatted'] = '<p class="outlook-comment-body" style="margin: 0 10px 0 15px; font-size: 12pt; font-family: Calibri,sans-serif; padding-bottom: 10px; line-height: 20px;">' . $comment->comment_body['und'][0]['formatted'] . '</p>';
		}
		// Add in link to parent article
		$parent = node_load($comment->nid);
		$comment->parent_url = drupal_get_path_alias('node/' . $comment->nid);
	} 

	
	//Fix formatting in bulleted lists in Take Note
	$notes = str_replace('<ul>', '<ul style="font-family: Calibri,sans-serif; font-size:12pt; margin-top: 10px; margin-right: 10px; margin-bottom: 20px;">', $notes);
	$notes = str_replace('<li>', '<li class="outlook-list" style="margin-left: 5px;">', $notes);
	
	// If a comment/note/did you know were NOT entered, our value should be "none" - we may want to account for this possibility here or in the template when deciding how exactly to theme in these instances
	$atwork_newsletter_render_array = array(
			"comments" => $comment,
			"take_note" => $notes,
			"did_you_know" => $did_you_know,
			"nodes" => array(),
	);
	
	//Directory/image locations on prod
	$articlesDir = '/sites/default/files/';
	$newsletterDir = '/var/www/html-8888/mem_fs/images/';
	$imgSrc = NULL;
	$imgDest = NULL;
	$error = NULL;
	foreach($nodes as $node) {
		//Keep track if no images are copied to img server for newsletter and inform user.
		$imgFound = FALSE;
		//Check to see if Article/Blog has a valid picture.
		if(isset($node->field_image['und']) && $node->field_image['und']){
			foreach($node->field_image['und'] as $newsletterImg) {
				$imgSrc = $articlesDir . substr($newsletterImg['uri'], 9);
				$imgDest = $newsletterDir . $newsletterImg['filename'];
				if(file_exists(DRUPAL_ROOT . $imgSrc)) {
				  	//Check image size first
				    if(array_search($node->nid,array_keys($nodes)) == 0) {
				    	//Feature spot image
				    	if(($newsletterImg['width'] <= '800' && $newsletterImg['width'] >= '700' )
				    		&& ($newsletterImg['height'] <= '300' && $newsletterImg['height'] >= '200' )) {
				    		if(!file_exists($imgDest)) {
				    			if(copy(DRUPAL_ROOT . $imgSrc, $imgDest)) {
				    			    $node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
				    				$imgFound = TRUE;
				    			}
				    			chmod($imgDest,0670);
				    		}
						    if(file_exists($imgDest)) {
						   	  //Verify file is now in memfs directory
				    		  $node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
						   	  $imgFound = TRUE;
						    }
				    	} else if(strpos($newsletterImg['filename'],'775') && (($newsletterImg['width'] > '700')&&($newsletterImg['height'] > '200'))) {
				    		if(!file_exists($imgDest)) {
				    			if(copy(DRUPAL_ROOT . $imgSrc, $imgDest)) {
				    				$node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
				    				$imgFound = TRUE;
				    			}
				    			chmod($imgDest,0670);
				    		}
				    		if(file_exists($imgDest)) {
				    			//Verify file is now in memfs directory
				    		    $node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
				    			$imgFound = TRUE;
				    		}
				    	}
				    } else {
				    	//Regular News article
				    	if(($newsletterImg['width'] <= '600' && $newsletterImg['width'] >= '200' ) 
				    		&& ($newsletterImg['height'] <= '600' && $newsletterImg['height'] >= '200' )) {
				    		if(!file_exists($imgDest)) {
				    			if(copy(DRUPAL_ROOT . $imgSrc, $imgDest)) {
				    				$node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
				    				$imgFound = TRUE;
				    			}
				    			chmod($imgDest,0670);
				    		}
						    if(file_exists($imgDest)) {
						   	  //Verify file is now in memfs directory
				    		  $node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
						   	  $imgFound = TRUE;
						    }
				    		
				    	} else if(strpos($newsletterImg['filename'],'382') && (($newsletterImg['width'] > '200')&&($newsletterImg['height'] > '200'))) {
				    		if(!file_exists($imgDest)) {
				    			if(copy(DRUPAL_ROOT . $imgSrc, $imgDest)) {
				    				$node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
				    				$imgFound = TRUE;
				    			}
				    			chmod($imgDest,0670);
				    		}
						    if(file_exists($imgDest)) {
						   	  //Verify file is now in memfs directory
				    		  $node->newsletter_image[] = array_search($newsletterImg, $node->field_image['und']);
						   	  $imgFound = TRUE;
						    }
				    	}
				    }
				}
			}
	        if(!$imgFound) {
	        	$node->field_image['und'][0]['uri'] = 'default_images/no_image_found_nl.jpg';
	        	$node->field_image['und'][1]['uri'] = 'default_images/no_image_found_nl.jpg';
	        }
		}
		// Image couldn't be transferred to/found in newsletter image folder. Inform user.
		if(!$imgFound && $node->type != 'blog') {
			$error .= "The image corresponding to <strong>" . $node->title . "</strong> could not be found.<br>";
		}
		
		//Update img path & then add node to render array.
		$atwork_newsletter_render_array['nodes'][$node->nid] = $node;
	} 
	if($error) {
	  drupal_set_message($error . "<br>Please check the images in the article to make sure they are uploaded in this order:<br>"
			. "&emsp;Small 382 X 250 px<br>"
			. "&emsp;Medium 775 X 250 px<br>"
			. "&emsp;Large 960 X 250 px<br>"
			. "The width must be included in the image title. For example \"Capital_Park_382x250\"", 'warning');
	}
	return($atwork_newsletter_render_array);
}